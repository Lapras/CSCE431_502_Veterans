<!-- app/views/attendances/index.html.erb -->
<% content_for :title, "Roll Call - #{@event.title}" %>

<h1>Roll Call: <%= @event.title %></h1>

<div class="user-details">
  <p><strong>Event:</strong> <%= @event.title %></p>
  <p><strong>Date:</strong> <%= @event.starts_at.strftime("%B %d, %Y at %I:%M %p") %></p>
  <p><strong>Location:</strong> <%= @event.location %></p>
</div>



<!-- Filters -->
<%= form_with url: event_attendances_path(@event), method: :get do |f| %>
  <div style="margin: 1rem 0; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
    <%= f.label :status_filter, "Filter by Status:", style: "margin-right: 0.5rem; font-weight: bold;" %>
    <%= f.select :status_filter, [["All", ""], ["Pending", "pending"], ["Present", "present"], ["Absent", "absent"], ["Tardy", "tardy"], ["Excused", "excused"]], {}, { onchange: "this.form.submit()" } %>

    <%= f.label :search, "Search:", style: "margin-left: 1rem; margin-right: 0.5rem; font-weight: bold;" %>
    <%= f.text_field :search, placeholder: "Name or email", style: "padding: 0.5rem;" %>
    <%= f.submit "Search", class: "action-button", style: "margin: 0;" %>

    <% if params[:status_filter].present? || params[:search].present? %>
      <%= link_to "Clear", event_attendances_path(@event), class: "action-button", style: "margin-left: 0.5rem;" %>
    <% end %>
  </div>
<% end %>

<%= form_with url: bulk_update_event_attendances_path(@event), method: :post do |f| %>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Status</th>
        <th>Checked In At</th>
        <th>Points</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @attendances.each do |attendance| %>
        <tr>
          <td><%= attendance.user.full_name %></td>
          <td><%= attendance.user.email %></td>
          <td>
            <%= select_tag "attendances[#{attendance.id}][status]",
                options_for_select(Attendance::STATUSES.map { |k, v| [v, k] }, attendance.status),
                class: "status-select" %>
          </td>
          <td><%= attendance.checked_in_at&.strftime("%I:%M %p") || "â€”" %></td>
          <td><%= attendance.point_value %></td>
          <td>
            <%= link_to "Edit", edit_event_attendance_path(@event, attendance) %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <div style="margin-top: 1rem;">
    <%= f.submit "Update All Attendance", class: "action-button" %>
  </div>
<% end %>

<div style="margin-top: 1rem;">
  <%= link_to "Back to Event Details", @event, class: "action-button" %>
  <%= link_to "Back to All Events", events_path, class: "action-button" %>
</div>